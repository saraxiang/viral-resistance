<!doctype html> 
<html lang="en"> 
	<head> 
		<meta charset="UTF-8" />
	    <title>Bird Game</title>

	    <!-- Style for some DOM elements -->
	    <link rel="stylesheet" type="text/css" href="style.css"/>

	    <!-- Style via SCSS, mainly for form rn -->
	    <link rel="stylesheet" type="text/css" href="output.css"/>

	    <!-- Adding Firebase -->
		<script src="https://www.gstatic.com/firebasejs/3.6.9/firebase.js"></script>
		<script>
		  // Initialize Firebase
		  var config = {
		    apiKey: "AIzaSyCnGdZV39hgow--2Yev49Fvt3gS_lcMcxs",
		    authDomain: "birdgame-aea72.firebaseapp.com",
		    databaseURL: "https://birdgame-aea72.firebaseio.com",
		    storageBucket: "birdgame-aea72.appspot.com",
		    messagingSenderId: "229376271005"
		  };
		  firebase.initializeApp(config);

		  var database = firebase.database();
		</script>

		<script type="text/javascript">

	    </script>

		<!-- Game engine -->
		<script type="text/javascript" src="js/phaser.min.js"></script>

		<!-- Needed for form detection of which radio button is clicked-->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
	</head>
	<body>
		<h1>Viral Resistance</h1>
		<!-- TODO: we don't handle case where sign in fails -->
	    <div id="sign-out">Sign Out</div>
		<div id="game"></div>
		<div id="article">
			<div id="url-box"> </div>
			<div id="top-bar"> </div>
			<div id="header-image"></div>
			<div id="body">
			  <div  id="author-picture"> </div>
			  <h3 id="author-info"> 
			  </h3>
			  <p id="p1"></p>
			  <div  id="quote"> </div>
			  <p id="p2"></p>
			</div>
		</div>

		<div id="form" class="radio-tile-group">
	  	</div>

		<script type="text/javascript">
		// var switchArticle = true;
		var uid;
		var articles;  //defined in initApp, pulled from database
		var states;  //defined in initApp, pulled from database

		// These variables define a player's view of the game
		var stateArray; //defined in initApp, either pulled from database or set to  [0, 1, 2, 3] (for new players)
		var currentState; //defined in initApp, either pulled from database or set to {loadedAssets:false} (for new players)
		var score; //defined in initApp, either pulled from database or set to 0 (for new players)
		// TODO: implement evidence and leads
		var evidence; //defined in initApp, either pulled from database or set to [] (for new players)
		var leads;	//defined in initApp, either pulled from database or set to [] (for new players)
		// TODO: we will likely need a global "userHistory" variable to hold history for each completed state


		// initApp gets user score, uid, stateArray, currentState from database, or initializes for new users
		// displays score, logs uid
		// also initializes states and articles variables
		initApp = function() {
	        firebase.auth().onAuthStateChanged(function(user) {
	          if (user) {
	            // User is signed in. TODO: how much of this info do we actually need?
	            var displayName = user.displayName;
	            var email = user.email;
	            var emailVerified = user.emailVerified;
	            var photoURL = user.photoURL;
	            uid = user.uid;
	            console.log("uid is: " + uid);

	            var providerData = user.providerData;
	            user.getToken().then(function(accessToken) {
	              // TODO: clean this code up
	              // Check if user exists (aka if not first time) 
	              var usersRef = firebase.database().ref('/users/');
	              usersRef.once('value').then(function(snapshot) {
	              	if (snapshot.child(uid).exists()) {
	              		// User exists, so get score, and set score accordingly
	              		firebase.database().ref('/users/' + uid).once('value').then(function(snapshot) {
	              			stateArray = snapshot.val().stateArray;
	              			currentState = snapshot.val().currentState;
		              		score = snapshot.val().score;
		              	});
	              	}
	              	else {
	              		// User doesn't exist, so create new node with uid, and set score to 0
	              		firebase.database().ref('users/' + uid).set({
	              			stateArray: [0,1,2,3],
	              			currentState: {loadedAssets:false},
					    	score: 0
					 	});
					 	stateArray = [0,1,2,3];
					 	currentState = {loadedAssets:false};
					 	score = 0;
	              	}
				  });
	            });
	          } else {
	            console.log("USER IS SIGNED OUT");
	          }
	        }, function(error) {
	          console.log(error);
	        });

	        firebase.database().ref('/articles').once('value').then(function(snapshot) {
		        articles = snapshot.val();
		    });

		    firebase.database().ref('/states').once('value').then(function(snapshot) {
		    	states = snapshot.val();
			});
	    };

	    signOut = function() {
		    firebase.auth().signOut().then(function() {
		    	window.location.href = "index.html";
			}, function(error) {
			  alert("Sign Out Error");
			  console.error('Sign Out Error', error);
			});
		};

	    var game = new Phaser.Game(1600, 800, Phaser.AUTO, 'game', { preload: preload, create: create, update: update });
	    var databaseLoaded = false;

	    function preload() {
		    // game.load.image('yesButton','assets/yesButton.jpg');
		    // game.load.image('noButton','assets/noButton.jpg');
		    game.load.image('nextButton', 'assets/next.png');
		    game.load.image('outerImage', 'assets/outer.jpg');
		}

		function create() {
			game.stage.backgroundColor = '#ADD8E6';
		}

		function update() {
			// checking that database has been accessed and all variables have been filled as needed before proceeding
			if (!databaseLoaded && stateArray && currentState) {
				currentState['loadedAssets'] = false;
				databaseLoaded = true;
				scoreText = game.add.text(16, 16, 'Score: ' + score, { fontSize: '32px', fill: '#000' });
			}
			else if (databaseLoaded) { 
				// TODO: stateArray should never be empty, catch and raise error if this is the case

				var currentStateId = stateArray[0];
				var currentStateType = states[currentStateId]['type'];

				if (currentStateType == 'start') {
					console.log("Starting!");
					handleStart();
				}

				if (currentStateType == 'outer') {
					console.log("In Outer Loop");
					handleOuter();
				}

				if (currentStateType == 'inner') {
					console.log("In Inner Loop");
					handleInner();
				}
			}
		}

		function updateCurrentState (x, y) {
			// TODO: clean up this function
			// update variable
			var key = arguments[0];
			var value = arguments[1];

			currentState[key] = value;
			//update database
			var update = currentState;
			var updates = {};
			updates['/users/' + uid + '/currentState/'] = update;
			firebase.database().ref().update(updates);
		}

		function nextState() {
			//update stateArray(remove element at index 0)
			stateArray.splice(0,1);
			//clear current state and set loadedAssets to false
			currentState = {loadedAssets: false};
		}

		function handleStart() {
			if (currentState['loadedAssets'] == false) {
				var nextButton = game.add.button(0, 50, 'nextButton', nextState, this);
				nextButton.scale.setTo(.2, .2);

				updateCurrentState('loadedAssets', true);
			}
		}

		function handleOuter() {
			if (currentState['loadedAssets'] == false) {
				console.log("loading assets for outer");
				var nextButton = game.add.button(0, 50, 'nextButton', nextState, this);
				nextButton.scale.setTo(.2, .2);

				game.add.sprite(200, 200, 'outerImage');

				updateCurrentState('loadedAssets', true);
			}
		}

		function handleInner() {
			if (currentState['loadedAssets'] == false) {

				var nextButton = game.add.button(0, 50, 'nextButton', nextState, this);
				nextButton.scale.setTo(.2, .2);

				// Note that if we don't want to load article (or ask questions, etc) immediately or at all we can definitely do that
				// Just add a variable in database, and act different based on it
				updateCurrentState('loadArticle', true);
				updateCurrentState('loadedArticle', false);
				updateCurrentState('askQuestions', true);
				updateCurrentState('switchQuestion', true);

				var currentStateId = stateArray[0];
				var articleId = states[currentStateId]['article'];

				updateCurrentState('prompts', articles[articleId]['questions']['prompt']);
				updateCurrentState('choices', articles[articleId]['questions']['choices']);
				updateCurrentState('numQuestions', currentState['prompts'].length);
				updateCurrentState('questionsCount', 0);				

				updateCurrentState('loadedAssets', true);
			}
			else {
				//relying on short-circuit evaluation: if we want to load and article and if it hasn't already been loaded, then load
				if (currentState['loadArticle'] && currentState['loadedArticle'] == false) {
					var currentStateId = stateArray[0];
					var articleId = states[currentStateId]['article'];
					var templateUsed = articles[articleId]['template']['num'];
					if (templateUsed == 0) loadTemplate0();
					updateCurrentState('loadedArticle', true);
				}

				// Once user choice detected, switchQuestion because true again. 
				// Once submit button is clicked, askQuestions becomes false 
				if (currentState['askQuestions'] && currentState['switchQuestion']) {
					var form = document.getElementById('form');
					var optionsArray = currentState['choices'][currentState['questionsCount']];
					var optionNum;
					var optionsHTML = "";
					for (optionNum = 0; optionNum < optionsArray.length; optionNum++) {
						optionsHTML  += '<div class="input-container"><input id="' + optionNum + '" class="radio-button" type="radio" name="radio" value ="' + optionsArray[optionNum] + '"/><div class="radio-tile"><label for="' + optionNum + '" class="radio-tile-label">' + optionsArray[optionNum] + '</label></div></div>'
					}
				 	form.innerHTML = optionsHTML
					updateCurrentState('questionsCount', currentState['questionsCount'] + 1);
					updateCurrentState('switchQuestion', false);

					// catches if user selects form option
					$('#form input').on('change', function() {
						console.log("gotit");
						updateCurrentState('switchQuestion', true);
						if (currentState['questionsCount'] == currentState['numQuestions']) updateCurrentState('askQuestions', false);
					    // alert($('input[name=radio]:checked', '#form').val()); 
					});
				}
			}
		}

		function loadTemplate0() {
			var article = document.getElementById('article');
			article.style.display = 'block';

			var p1Text = articles[0]['template']['p1'];
			var p1Node = document.getElementById('p1');
			p1Node.innerHTML = p1Text;

			var p2Text = articles[0]['template']['p2'];
			var p2Node = document.getElementById('p2');
			p2Node.innerHTML = p2Text;

			var authorInfoText = articles[0]['template']['author'] + '<br>' + articles[0]['template']['authorTitle'];
			var authorInfoNode = document.getElementById('author-info');
			authorInfoNode.innerHTML = authorInfoText;
			// var headerImageUrl = '<div id="header-image" style="background-image: url("assets/someName.jpg");"></div>'
			// var headerImageUrl = '<div id="header-image" style="height: 200px;background-size: cover;background-repeat: no-repeat;background-image: url("someName.jpg");"></div>';
			// var headerImageNode = document.getElementById('header-wrapper');
			// headerImageNode.innerHTML = headerImageUrl;

			// var newDiv = document.createElement("header-image"); 
			// var body = document.getElementById("body"); 
 			// 	document.body.insertBefore(newDiv, body); 
			// var i = document.createElement('div');
		}

		// function determineScore(userChosen) {
		// 	var correct = articles[0]['answer'];
		// 	if (correct == 'fake' && userChosen == 'fake') {
		// 		alert("CORRECT!");
		// 		return score + 1;
		// 	}
		// 	if (correct == 'real' && userChosen == 'real') {
		// 		alert("CORRECT!");
		// 		return score + 1;
		// 	}
		// 	alert("WRONG!");
		// 	return score - 1;
		// }

		// function updateScore() {
		// 	var newData = {
		// 		score: score 
		// 	};

		// 	var updates = {};
		// 	updates['/users/' + uid] = newData;

		// 	firebase.database().ref().update(updates);
		// 	scoreText.text = 'Score: ' + score;
		// }

		// function nextArticle() {
		// 	var article = document.getElementById('article');
		// 	article.style.display = 'none';
		// 	articles.splice(0,1); 
		// 	switchArticle = true;
		// }

		// function yesClicked(button) {
		// 	score = determineScore('real');

		// 	updateScore();

		// 	nextArticle();
		// }

		// function noClicked(button) {
		// 	score = determineScore('fake');

	 //  		updateScore();

		// 	nextArticle();
		// }

		//Sign out button signs user out and redirects to login page
		var signOutButton = document.getElementById('sign-out');
		signOutButton.style.cursor = 'pointer';
		signOutButton.onclick = signOut;

	    window.addEventListener('load', function() {
	        initApp()
	    });

		</script>
	</body>
</html>