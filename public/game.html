<!doctype html> 
<html lang="en"> 
	<head> 
		<meta charset="UTF-8" />
	    <title>Bird Game</title>

	    <!-- Style for some DOM elements -->
	    <link rel="stylesheet" type="text/css" href="style.css"/>

	    <!-- Style via SCSS, mainly for form rn -->
	    <link rel="stylesheet" type="text/css" href="output.css"/>

	    <!-- Adding Firebase -->
		<script src="https://www.gstatic.com/firebasejs/3.6.9/firebase.js"></script>
		<script>
		  // Initialize Firebase
		  var config = {
		    apiKey: "AIzaSyCnGdZV39hgow--2Yev49Fvt3gS_lcMcxs",
		    authDomain: "birdgame-aea72.firebaseapp.com",
		    databaseURL: "https://birdgame-aea72.firebaseio.com",
		    storageBucket: "birdgame-aea72.appspot.com",
		    messagingSenderId: "229376271005"
		  };
		  firebase.initializeApp(config);

		  var database = firebase.database();
		</script>

		<script type="text/javascript">

	    </script>

		<!-- Game engine -->
		<script type="text/javascript" src="js/phaser.min.js"></script>

		<!-- Needed for form detection of which radio button is clicked-->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
	</head>
	<body>
		<h1>Viral Resistance</h1>
		<!-- TODO: we don't handle case where sign in fails -->
	    <div id="sign-out">Sign Out</div>
		<div id="game"></div>
		<div id="article">
			<div id="url-box"> </div>
			<div id="top-bar"> </div>
			<div id="header-image"></div>
			<div id="body">
			  <div  id="author-picture"> </div>
			  <h3 id="author-info"> 
			  </h3>
			  <p id="p1"></p>
			  <div  id="quote"> </div>
			  <p id="p2"></p>
			</div>
		</div>

		<div id="form" class="radio-tile-group">
	  	</div>

		<script type="text/javascript">
		var score; 
		var uid;
		var switchArticle = true;
		var articles;
		var activeArticle;
		var askQuestions = false;
		var switchQuestion = true;
		var prompts;
		var choices;
		var numQuestions;
		var questionsCount;

		// initApp gets score and uid from database, displays score
		initApp = function() {
	        firebase.auth().onAuthStateChanged(function(user) {
	          if (user) {
	            // User is signed in. TODO: how much of this info do we actually need?
	            var displayName = user.displayName;
	            var email = user.email;
	            var emailVerified = user.emailVerified;
	            var photoURL = user.photoURL;
	            uid = user.uid;

	            var providerData = user.providerData;
	            user.getToken().then(function(accessToken) {
	              // TODO: clean this code up
	              // Check if user exists (aka if not first time) 
	              var usersRef = firebase.database().ref('/users/');
	              usersRef.once('value').then(function(snapshot) {
	              	if (snapshot.child(uid).exists()) {
	              		// User exists, so get score, and set score accordingly
	              		firebase.database().ref('/users/' + uid).once('value').then(function(snapshot) {
		              		score = snapshot.val().score;
		              	});
	              	}
	              	else {
	              		// User doesn't exist, so create new node with uid, and set score to 0
	              		firebase.database().ref('users/' + uid).set({
					    	score: 0
					 	});
					 	score = 0;
	              	}
				  });
	            });
	          } else {
	            console.log("USER IS SIGNED OUT");
	          }
	        }, function(error) {
	          console.log(error);
	        });

	        firebase.database().ref('/articles').once('value').then(function(snapshot) {
		        articles = snapshot.val();
		    });
	    };

	    signOut = function() {
		    firebase.auth().signOut().then(function() {
		    	window.location.href = "index.html";
			}, function(error) {
			  alert("Sign Out Error");
			  console.error('Sign Out Error', error);
			});
		};

	    var game = new Phaser.Game(1600, 800, Phaser.AUTO, 'game', { preload: preload, create: create, update: update });
	    var scoreLoaded = false;

	    function preload() {
		    game.load.image('yesButton','assets/yesButton.jpg');
		    game.load.image('noButton','assets/noButton.jpg');
		}

		function create() {
			game.stage.backgroundColor = '#ADD8E6';

			var noButton = game.add.button(100, 50, 'noButton', noClicked, this);
			noButton.scale.setTo(.2, .2);

			var yesButton = game.add.button(0, 50, 'yesButton', yesClicked, this);
			yesButton.scale.setTo(.2, .2);
		}

		function update() {
			// TODO: is there a better fix? currently can't set scoreText initially in create because calls to Firebase
			// may not have returned to get the score, so Score: Undefined is printed 
			if (!scoreLoaded && score) {
				scoreLoaded = true;
				scoreText = game.add.text(16, 16, 'Score: ' + score, { fontSize: '32px', fill: '#000' });
			}

			if (switchArticle && articles && articles.length != 0) {
				// Article at index 0 will be this article until user clicks yesButton, or noButton, 
				// after which switchArticle is set to true, score is updated, and article at index 0 is removed

				// TODO: load new article
				var templateUsed = articles[0]['template']['num'];
				if (templateUsed == 0) loadTemplate0();
				switchArticle = false;
			}

			// Once user choice detected, switchQuestion because true again. 
			// Once submit button is clicked, askQuestions becomes false 
			if (askQuestions && switchQuestion) {
				var form = document.getElementById('form');
				var optionsArray = choices[questionsCount];
				var optionNum;
				var optionsHTML = "";
				for (optionNum = 0; optionNum < optionsArray.length; optionNum++) {
					optionsHTML  += '<div class="input-container"><input id="' + optionNum + '" class="radio-button" type="radio" name="radio" value ="' + optionsArray[optionNum] + '"/><div class="radio-tile"><label for="' + optionNum + '" class="radio-tile-label">' + optionsArray[optionNum] + '</label></div></div>'
				}
			 	form.innerHTML = optionsHTML
				questionsCount++;
				switchQuestion = false;

				// catches if user selects form option
				$('#form input').on('change', function() {
					console.log("gotit");
					switchQuestion = true;
					if (questionsCount == numQuestions) askQuestions = false;
				    // alert($('input[name=radio]:checked', '#form').val()); 
				});
			}
		}

		function loadTemplate0() {
			var article = document.getElementById('article');
			article.style.display = 'block';

			var p1Text = articles[0]['template']['p1'];
			var p1Node = document.getElementById('p1');
			p1Node.innerHTML = p1Text;

			var p2Text = articles[0]['template']['p2'];
			var p2Node = document.getElementById('p2');
			p2Node.innerHTML = p2Text;

			var authorInfoText = articles[0]['template']['author'] + '<br>' + articles[0]['template']['authorTitle'];
			var authorInfoNode = document.getElementById('author-info');
			authorInfoNode.innerHTML = authorInfoText;

			askQuestions = true;
			prompts = articles[0]['questions']['prompt'];
			choices = articles[0]['questions']['choices'];
			numQuestions = prompts.length;
			questionsCount = 0;

			// var headerImageUrl = '<div id="header-image" style="background-image: url("assets/someName.jpg");"></div>'
			// var headerImageUrl = '<div id="header-image" style="height: 200px;background-size: cover;background-repeat: no-repeat;background-image: url("someName.jpg");"></div>';
			// var headerImageNode = document.getElementById('header-wrapper');
			// headerImageNode.innerHTML = headerImageUrl;

			// var newDiv = document.createElement("header-image"); 
			// var body = document.getElementById("body"); 
 			// 	document.body.insertBefore(newDiv, body); 
			// var i = document.createElement('div');
		}

		function nextArticle() {
			var article = document.getElementById('article');
			article.style.display = 'none';
			articles.splice(0,1); 
			switchArticle = true;
		}

		function determineScore(userChosen) {
			var correct = articles[0]['answer'];
			if (correct == 'fake' && userChosen == 'fake') {
				alert("CORRECT!");
				return score + 1;
			}
			if (correct == 'real' && userChosen == 'real') {
				alert("CORRECT!");
				return score + 1;
			}
			alert("WRONG!");
			return score - 1;
		}

		function updateScore() {
			var newData = {
				score: score 
			};

			var updates = {};
			updates['/users/' + uid] = newData;

			firebase.database().ref().update(updates);
			scoreText.text = 'Score: ' + score;
		}

		function yesClicked(button) {
			score = determineScore('real');

			updateScore();

			nextArticle();
		}

		function noClicked(button) {
			score = determineScore('fake');

	  		updateScore();

			nextArticle();
		}

		//Sign out button signs user out and redirects to login page
		var signOutButton = document.getElementById('sign-out');
		signOutButton.style.cursor = 'pointer';
		signOutButton.onclick = signOut;

	    window.addEventListener('load', function() {
	        initApp()
	    });

		</script>
	</body>
</html>