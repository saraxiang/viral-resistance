<!doctype html> 
<html lang="en"> 
	<head> 
		<meta charset="UTF-8" />
	    <title>Bird Game</title>

	    <!-- Style for some DOM elements -->
	    <link rel="stylesheet" type="text/css" href="style.css"/>

	    <!-- Style via SCSS, mainly for form rn -->
	    <link rel="stylesheet" type="text/css" href="output.css"/>

	    <!-- Adding Firebase -->
		<script src="https://www.gstatic.com/firebasejs/3.6.9/firebase.js"></script>
		<script>
		  // Initialize Firebase
		  var config = {
		    apiKey: "AIzaSyCnGdZV39hgow--2Yev49Fvt3gS_lcMcxs",
		    authDomain: "birdgame-aea72.firebaseapp.com",
		    databaseURL: "https://birdgame-aea72.firebaseio.com",
		    storageBucket: "birdgame-aea72.appspot.com",
		    messagingSenderId: "229376271005"
		  };
		  firebase.initializeApp(config);

		  var database = firebase.database();
		</script>

		<!-- Game engine -->
		<script type="text/javascript" src="js/phaser.min.js"></script>

		<!-- Needed for form detection of which radio button is clicked-->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
	</head>
	<body>
		<h1>Viral Resistance</h1>
		<div id="sign-out">Sign Out</div>
	    <div id="reset">Reset</div>
		<div id="game"></div>
		<!-- TODO: we don't handle case where sign in fails -->
		<div id="article">
			<div id="url-box"> </div>
			<div id="top-bar"> </div>
			<div id="header-image"></div>
			<div id="body">
			  <div  id="author-picture"> </div>
			  <h3 id="author-info"> 
			  </h3>
			  <p id="p1"></p>
			  <div  id="quote"> </div>
			  <p id="p2"></p>
			</div>
		</div>

		<div id="form" class="radio-tile-group">
	  	</div>

		<script type="text/javascript">
		var uid;  //user id
		var articles;  //defined in initApp, pulled from database
		var states;  //defined in initApp, pulled from database

		// These variables define a player's view of the game
		var stateArray; //defined in initApp, either pulled from database or set to  initialState (for new players)
		var initialState = [0,1,4,5];
		var currentState; //defined in initApp, either pulled from database or set to {loadedAssets:false} (for new players)
		var score; //defined in initApp, either pulled from database or set to 0 (for new players)
		// TODO: implement evidence and leads
		var evidence; //defined in initApp, either pulled from database or set to [] (for new players)
		var leads;	//defined in initApp, either pulled from database or set to [] (for new players)
		// TODO: we will likely need a global "userHistory" variable to hold history for each completed state

		// This will be defined by handleOuter() and destroyed by nextStateAfterOuter
		var outerImage;
		// This will be defined by complexInnerStateHandleLinkSelection, and cleared when a leaf node is reached by handleComplexInner
		var CINodes;

		// flipped to true when stateArray and currentState variables are no longer mll
		var databaseLoaded = false;

		// initApp gets user score, uid, stateArray, currentState from database, or initializes for new users
		// displays score, logs uid
		// also initializes states and articles variables
		initApp = function() {
	        firebase.auth().onAuthStateChanged(function(user) {
	          if (user) {
	            // User is signed in. TODO: how much of this info do we actually need?
	            var displayName = user.displayName;
	            var email = user.email;
	            var emailVerified = user.emailVerified;
	            var photoURL = user.photoURL;
	            uid = user.uid;
	            console.log("uid is: " + uid);

	            var providerData = user.providerData;
	            user.getToken().then(function(accessToken) {
	              // TODO: clean this code up
	              // Check if user exists (aka if not first time) 
	              var usersRef = firebase.database().ref('/users/');
	              usersRef.once('value').then(function(snapshot) {
	              	if (snapshot.child(uid).exists()) {
	              		// User exists, so get score, and set score accordingly
	              		firebase.database().ref('/users/' + uid).once('value').then(function(snapshot) {
	              			stateArray = snapshot.val().stateArray;
	              			currentState = snapshot.val().currentState;
		              		score = snapshot.val().score;
		              	});
	              	}
	              	else {
	              		// User doesn't exist, so create new node with uid, and set score to 0
	              		firebase.database().ref('users/' + uid).set({
	              			stateArray: initialState,
	              			currentState: {loadedAssets:false},
					    	score: 0
					 	});
					 	stateArray = initialState;
					 	currentState = {loadedAssets:false};
					 	score = 0;
	              	}
				  });
	            });
	          } else {
	            console.log("USER IS SIGNED OUT");
	          }
	        }, function(error) {
	          console.log(error);
	        });

	        firebase.database().ref('/articles').once('value').then(function(snapshot) {
		        articles = snapshot.val();
		    });

		    firebase.database().ref('/states').once('value').then(function(snapshot) {
		    	states = snapshot.val();
			});
	    };

	    signOut = function() {
		    firebase.auth().signOut().then(function() {
		    	window.location.href = "index.html";
			}, function(error) {
			  alert("Sign Out Error");
			  console.error('Sign Out Error', error);
			});
		};

		reset = function() {
			updateStateArray(initialState);
			clearCurrentState();
			window.location.reload();
		}

		function sleep(ms) {
		  return new Promise(resolve => setTimeout(resolve, ms));
		}

	    var game = new Phaser.Game(512, 683, Phaser.AUTO, 'game', { preload: preload, create: create, update: update });

	    // PhaserJS function, preloads assets
	    function preload() {
		    // game.load.image('yesButton','assets/yesButton.jpg');
		    // game.load.image('noButton','assets/noButton.jpg');
		    game.load.image('nextButton', 'assets/next.png');
		    game.load.image('outerImage', 'assets/outer.jpg');
		    game.load.image('endImage', 'assets/end.jpg');
		}

		// PhaserJS function, creates game background
		function create() {
			game.stage.backgroundColor = '#ADD8E6';
		}

		// PhaserJS Function, called repeatedly
		function update() {
			// checking that database has been accessed and all variables have been filled as needed before proceeding
			if (!databaseLoaded && stateArray && currentState) {
				currentState['loadedAssets'] = false;
				databaseLoaded = true;
				scoreText = game.add.text(16, 16, 'Score: ' + score, { fontSize: '32px', fill: '#000' });
			}
			else if (databaseLoaded) { 
				// TODO: stateArray should never be empty, catch and raise error if this is the case

				var currentStateId = stateArray[0];
				var currentStateType = states[currentStateId]['type'];

				if (currentStateType == 'start') {
					console.log("Starting!");
					handleStart();
				}

				if (currentStateType == 'outer') {
					console.log("In Outer Loop");
					handleOuter();
				}

				if (currentStateType == 'inner') {
					console.log("In Inner Loop");
					handleInner();
				}

				if (currentStateType == 'complexInner') {
					console.log("In Complex Inner Loop!");
					handleComplexInner();
				}

				if (currentStateType == 'end') {
					console.log("Finished!");
					handleEnd();
				}
			}
		}

		function clearCurrentState() {
			currentState = {loadedAssets:false};;
			var update = {'loadedAssets':false} ;
			var updates = {};
			updates['/users/' + uid + '/currentState/'] = update;
			firebase.database().ref().update(updates);
		}

		function updateCurrentState (x, y) {
			// TODO: clean up this function
			// update variable
			var key = arguments[0];
			var value = arguments[1];

			currentState[key] = value;
			//update database
			var update = currentState;
			var updates = {};
			updates['/users/' + uid + '/currentState/'] = update;
			firebase.database().ref().update(updates);
		}

		function updateStateArray (newStateArray) {
			// TODO: clean up this function
			// update variable
			var newStateArray = arguments[0];

			var updates = {};
			updates['/users/' + uid + '/stateArray/'] = newStateArray;
			firebase.database().ref().update(updates);
		}

		function nextState() {
			//update stateArray(remove element at index 0)
			stateArray.splice(0,1);
			updateStateArray(stateArray);
			//clear current state and set loadedAssets to false
			clearCurrentState();
		}

		// TODO: nextState function should test for current state, and handle appropriately; shouldn't need this function
		function nextStateAfterOuter() {
			//delete...
			outerImage.destroy();
			//update stateArray(remove element at index 0)
			stateArray.splice(0,1);
			updateStateArray(stateArray);
			//clear current state and set loadedAssets to false
			updateCurrentState('loadedAssets', false);
		}

		function nextStateAfterComplexInner() {
			deleteArticleAndForm();

			stateArray.splice(0,1);
			updateStateArray(stateArray);
			//clear current state and set loadedAssets to false
			updateCurrentState('loadedAssets', false);
		}

		// Waiting a bit before handling to let the pretty animation happen...
		async function innerStateHandleUserFormChoiceSelection() {
		  await sleep(300);
		  updateCurrentState('switchQuestion', true);
		  if (currentState['questionsCount'] == currentState['numQuestions']) {
		  	updateCurrentState('askQuestions', false);
		  	deleteArticleAndForm();
		  }
		}

		function complexInnerStateHandleUserFormChoiceSelection(id) {
			// flip switchQuestion to true, use the choice to index into next CINode, add to beginning of CINodes array; UNLESS if a choice is "Go Back" or "On Second Thought" then pop off the first element of the CINodes array
			// TODO: don't just check for content to go back or not
			updateCurrentState('switchQuestion', true);
			if (CINodes[0]['choices'][id]['text'] == 'Go back' || CINodes[0]['choices'][id]['text'] == 'On second thought...') CINodes.splice(0,1);
			else CINodes.unshift(CINodes[0]['choices'][id]);
			console.log("CINodes is: " + CINodes);
		}

		function complexInnerStateHandleUserLinkSelection(id) {
			var currentStateId = stateArray[0];
			var articleId = states[currentStateId]['article'];

			// Create new elements for interactions related to this link
			var complexInnerDiv = document.createElement("div"); 
			complexInnerDiv.setAttribute("id", 'complex-inner');
			complexInnerDiv.style.backgroundImage = 'url(assets/complexInner/' + articleId + '/' + id + '.jpg)';
			var backToArticle = document.createElement("div");
			backToArticle.setAttribute("id", 'back-to-article');
			backToArticle.style.backgroundImage = 'url(assets/complexInner/' + articleId + '/backToArticle.jpg)';
			backToArticle.style.cursor = 'pointer';
			backToArticle.onclick = function() {
				document.getElementById("complex-inner").remove();
			};
			document.getElementById('game').appendChild(complexInnerDiv);
			document.getElementById('complex-inner').appendChild(backToArticle);

			// flip switchQuestion to true, initialize CINodes array
			updateCurrentState('switchQuestion', true);
			var currentStateId = stateArray[0];
			var articleId = states[currentStateId]['article'];
			var treeRoot = articles[articleId]['trees'][id];
			CINodes = [treeRoot];
			console.log(CINodes);
		}

		function handleStart() {
			if (currentState['loadedAssets'] == false) {
				var nextButton = game.add.button(0, 50, 'nextButton', nextState, this);
				nextButton.scale.setTo(.2, .2);

				updateCurrentState('loadedAssets', true);
			}
		}

		function handleOuter() {
			if (currentState['loadedAssets'] == false) {
				outerImage = game.add.sprite(200, 200, 'outerImage');

				var nextButton = game.add.button(0, 50, 'nextButton', nextStateAfterOuter, this);
				nextButton.scale.setTo(.2, .2);

				updateCurrentState('loadedAssets', true);
			}
		}

		function handleComplexInner() {
			if (currentState['loadedAssets'] == false) {

				var nextButton = game.add.button(0, 50, 'nextButton', nextStateAfterComplexInner, this);
				nextButton.scale.setTo(.2, .2);

				// Note that if we don't want to load article (or ask questions, etc) immediately or at all we can definitely do that
				// Just add a variable in database, and act different based on it

				// We want to load an article
				updateCurrentState('loadArticle', true);
				// But we haven't yet
				updateCurrentState('loadedArticle', false);
				// We want to ask questions
				updateCurrentState('askQuestions', true);
				// But we don't want to ask one until the user clicks on a link
				updateCurrentState('switchQuestion', false);			

				updateCurrentState('loadedAssets', true);
			}
			else {
				//relying on short-circuit evaluation: if we want to load an article and if it hasn't already been loaded, then load
				if (currentState['loadArticle'] && currentState['loadedArticle'] == false) {
					// TODO: should not take two lines to get articleId; make 
					// currentArticleId a global?
					var currentStateId = stateArray[0];
					var articleId = states[currentStateId]['article'];
					var templateUsed = articles[articleId]['template']['num'];
					console.log("articleID: " + articleId);
					console.log("templateUsed: " + templateUsed);
					if (templateUsed == 0) loadTemplate0(articleId);
					else if (templateUsed == 1) loadTemplate1(articleId);
					updateCurrentState('loadedArticle', true);
				}

				// Once user choice detected, switchQuestion because true again. 
				// Once submit button is clicked, askQuestions becomes false 
				if (currentState['askQuestions'] && currentState['switchQuestion']) {
					// CINode will have been updated either by function
					// complexInnerStateHandleUserLinkSelection (called when new tree is
					// initialized/new link in article is clicked) or by 
					// complexInnerStateHandleUserFormChoiceSelection() (called when
					// user selects choice in a form)
					updateCurrentState('switchQuestion', false);
					if (CINodes.length == 0) {
						form.innerHTML = '';
					}
					else if (CINodes[0]['leaf']) {
						CINodes = [];
						form.innerHTML = '';
					}
					else complexInnerStateLoadForm();
				}
			}
		}

		function handleInner() {
			if (currentState['loadedAssets'] == false) {

				var nextButton = game.add.button(0, 50, 'nextButton', nextState, this);
				nextButton.scale.setTo(.2, .2);

				// Note that if we don't want to load article (or ask questions, etc) immediately or at all we can definitely do that
				// Just add a variable in database, and act different based on it

				// We want to load an article
				updateCurrentState('loadArticle', true);
				// But we haven't yet
				updateCurrentState('loadedArticle', false);
				// We want to ask questions
				updateCurrentState('askQuestions', true);
				// And we want a new one right now
				updateCurrentState('switchQuestion', true);

				var currentStateId = stateArray[0];
				var articleId = states[currentStateId]['article'];

				// TODO: change updateCurrentState to take array of things to change,not
				// one at a time (also firebase let's us give up multiple things to 
				// update, so should be taking advantage of that...)
				updateCurrentState('prompts', articles[articleId]['questions']['prompt']);
				updateCurrentState('choices', articles[articleId]['questions']['choices']);
				updateCurrentState('numQuestions', currentState['prompts'].length);
				updateCurrentState('questionsCount', 0);				

				updateCurrentState('loadedAssets', true);
			}
			else {
				//relying on short-circuit evaluation: if we want to load an article and if it hasn't already been loaded, then load
				if (currentState['loadArticle'] && currentState['loadedArticle'] == false) {
					var currentStateId = stateArray[0];
					var articleId = states[currentStateId]['article'];
					var templateUsed = articles[articleId]['template']['num'];
					if (templateUsed == 0) loadTemplate0(articleId);
					updateCurrentState('loadedArticle', true);
				}

				// Once user choice detected, switchQuestion because true again. 
				// Once submit button is clicked, askQuestions becomes false 
				if (currentState['askQuestions'] && currentState['switchQuestion']) {
					innerStateLoadForm();
				}
			}
		}

		function handleEnd() {
			if (currentState['loadedAssets'] == false) {
				var endImage = game.add.sprite(200, 200, 'endImage');
				endImage.scale.setTo(.2,.2);
				updateCurrentState('loadedAssets', true);
			}
		}

		function deleteArticleAndForm() {
			var article = document.getElementById('article');
			var form = document.getElementById('form');
			form.innerHTML = '';
			article.innerHTML = '<div id="url-box"></div><div id="top-bar"> </div><div id="header-image"></div><div id="body"><div  id="author-picture"> </div><h3 id="author-info"> </h3><p id="p1"></p><div  id="quote"> </div><p id="p2"></p></div>'
			article.style.display = 'none';
		}

		function innerStateLoadForm() {
			var form = document.getElementById('form');
			var optionsArray = currentState['choices'][currentState['questionsCount']];
			var optionNum;
			var optionsHTML = "";
			for (optionNum = 0; optionNum < optionsArray.length; optionNum++) {
				optionsHTML  += '<div class="input-container"><input id="' + optionNum + '" class="radio-button" type="radio" name="radio" value ="' + optionsArray[optionNum] + '"/><div class="radio-tile"><label for="' + optionNum + '" class="radio-tile-label">' + optionsArray[optionNum] + '</label></div></div>'
			}
		 	form.innerHTML = optionsHTML;
			updateCurrentState('questionsCount', currentState['questionsCount'] + 1);
			updateCurrentState('switchQuestion', false);

			// catches if user selects form option
			$('#form input').on('change', function() {
				console.log("gotit");
				innerStateHandleUserFormChoiceSelection();
			});
		}

		function complexInnerStateLoadForm() {
			// each option in the form needs to pass its text or some other identifying info
			// to complexInnerStateHandleUserFormChoiceSelection()
			var form = document.getElementById('form');
			var optionsArray = CINodes[0]['choices'];
			var optionNum;
			var optionsHTML = "";
			for (optionNum = 0; optionNum < optionsArray.length; optionNum++) {
				optionsHTML  += '<div class="input-container"><input id="' + optionNum + '" class="radio-button" type="radio" name="radio" value ="' + optionsArray[optionNum]['text'] + '"/><div class="radio-tile"><label for="' + optionNum + '" class="radio-tile-label">' + optionsArray[optionNum]['text'] + '</label></div></div>'
			}
		 	form.innerHTML = optionsHTML;
			updateCurrentState('switchQuestion', false);

			// catches if user selects form option
			$('#form input').on('change', function() {
				complexInnerStateHandleUserFormChoiceSelection(this.getAttribute('id'));
			});
		}

		function loadTemplate1(articleId) {
			var article = document.getElementById('article');
			article.style.display = 'block';

			// important TODO: need invariant that article
			// has corresponding template number, OR better: create a handle load template 
			// function that just takes in the article id as a parameter and calls 
			// appropriate load functions
			var p1Text = articles[articleId]['template']['p1'];
			var p1Node = document.getElementById('p1');
			p1Node.innerHTML = p1Text;

			var authorInfoText = articles[articleId]['template']['author']
			var authorInfoNode = document.getElementById('author-info');
			authorInfoNode.innerHTML = authorInfoText;

			var authorPicture = document.getElementById('author-picture');
			var quote = document.getElementById('quote');
			var headerImage = document.getElementById('header-image');
			authorPicture.style.display = 'none';
			quote.style.display = 'none';
			headerImage.style.display = 'none';

			var allLinks = article.getElementsByTagName('a');

			// Bind the event handler to each link individually
			for (var i = 0, n = allLinks.length; i < n; i++) {
			    allLinks[i].onclick = function () {
			        var id = $(this).attr('id');
			        console.log("click detected. id is: " + id);
			        complexInnerStateHandleUserLinkSelection(id);            
			    };
			}
		}

		function loadTemplate0(articleId) {
			var article = document.getElementById('article');
			article.style.display = 'block';

			var p1Text = articles[articleId]['template']['p1'];
			var p1Node = document.getElementById('p1');
			p1Node.innerHTML = p1Text;

			var p2Text = articles[articleId]['template']['p2'];
			var p2Node = document.getElementById('p2');
			p2Node.innerHTML = p2Text;

			var authorInfoText = articles[articleId]['template']['author'] + '<br>' + articles[articleId]['template']['authorTitle'];
			var authorInfoNode = document.getElementById('author-info');
			authorInfoNode.innerHTML = authorInfoText;
			// var headerImageUrl = '<div id="header-image" style="background-image: url("assets/someName.jpg");"></div>'
			// var headerImageUrl = '<div id="header-image" style="height: 200px;background-size: cover;background-repeat: no-repeat;background-image: url("someName.jpg");"></div>';
			// var headerImageNode = document.getElementById('header-wrapper');
			// headerImageNode.innerHTML = headerImageUrl;

			// var newDiv = document.createElement("header-image"); 
			// var body = document.getElementById("body"); 
 			// 	document.body.insertBefore(newDiv, body); 
			// var i = document.createElement('div');
		}

		// function determineScore(userChosen) {
		// 	var correct = articles[0]['answer'];
		// 	if (correct == 'fake' && userChosen == 'fake') {
		// 		alert("CORRECT!");
		// 		return score + 1;
		// 	}
		// 	if (correct == 'real' && userChosen == 'real') {
		// 		alert("CORRECT!");
		// 		return score + 1;
		// 	}
		// 	alert("WRONG!");
		// 	return score - 1;
		// }

		// function updateScore() {
		// 	var newData = {
		// 		score: score 
		// 	};

		// 	var updates = {};
		// 	updates['/users/' + uid] = newData;

		// 	firebase.database().ref().update(updates);
		// 	scoreText.text = 'Score: ' + score;
		// }

		// function nextArticle() {
		// 	var article = document.getElementById('article');
		// 	article.style.display = 'none';
		// 	articles.splice(0,1); 
		// 	switchArticle = true;
		// }

		// function yesClicked(button) {
		// 	score = determineScore('real');

		// 	updateScore();

		// 	nextArticle();
		// }

		// function noClicked(button) {
		// 	score = determineScore('fake');

	 	//  		updateScore();

		// 	nextArticle();
		// }

		//Sign out button signs user out and redirects to login page
		var signOutButton = document.getElementById('sign-out');
		signOutButton.style.cursor = 'pointer';
		signOutButton.onclick = signOut;

		//Reset stateArray to initialState
		var resetButton = document.getElementById('reset');
		resetButton.style.cursor = 'pointer';
		resetButton.onclick = reset;

	    window.addEventListener('load', function() {
	        initApp()
	    });

		</script>
	</body>
</html>