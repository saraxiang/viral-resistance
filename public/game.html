<!doctype html> 
<html lang="en"> 
	<head> 
		<meta charset="UTF-8" />
	    <title>Bird Game</title>

	    <!-- Adding Firebase -->
		<script src="https://www.gstatic.com/firebasejs/3.6.9/firebase.js"></script>
		<script>
		  // Initialize Firebase
		  var config = {
		    apiKey: "AIzaSyCnGdZV39hgow--2Yev49Fvt3gS_lcMcxs",
		    authDomain: "birdgame-aea72.firebaseapp.com",
		    databaseURL: "https://birdgame-aea72.firebaseio.com",
		    storageBucket: "birdgame-aea72.appspot.com",
		    messagingSenderId: "229376271005"
		  };
		  firebase.initializeApp(config);

		  var database = firebase.database();
		</script>

		<script type="text/javascript">

	    </script>

		<!-- Game engine -->
		<script type="text/javascript" src="js/phaser.min.js"></script>

		<!-- TODO: this may be unnecessary -->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
	</head>
	<body>
		<h1>Welcome to the Bird Game :D</h1>
		<!-- TODO: we don't handle case where sign in fails -->
	    <div id="sign-out">Sign Out</div>
	    <div id="score"></div>
		<div id="game"></div>

		<script type="text/javascript">
		var score; 
		var uid;
		var switchArticle = true;
		var articles;
		var activeArticle;

		// initApp gets score and uid from database, displays score
		initApp = function() {
	        firebase.auth().onAuthStateChanged(function(user) {
	          if (user) {
	            // User is signed in. TODO: how much of this info do we actually need?
	            var displayName = user.displayName;
	            var email = user.email;
	            var emailVerified = user.emailVerified;
	            var photoURL = user.photoURL;
	            uid = user.uid;

	            var providerData = user.providerData;
	            user.getToken().then(function(accessToken) {
	              // TODO: clean this code up
	              // Check if user exists (aka if not first time) 
	              var usersRef = firebase.database().ref('/users/');
	              usersRef.once('value').then(function(snapshot) {
	              	if (snapshot.child(uid).exists()) {
	              		// User exists, so get score, and set score accordingly
	              		firebase.database().ref('/users/' + uid).once('value').then(function(snapshot) {
		              		score = snapshot.val().score;
		              	});
	              	}
	              	else {
	              		// User doesn't exist, so create new node with uid, and set score to 0
	              		firebase.database().ref('users/' + uid).set({
					    	score: 0
					 	});
					 	score = 0;
	              	}
				  });
	            });
	          } else {
	            console.log("USER IS SIGNED OUT");
	          }
	        }, function(error) {
	          console.log(error);
	        });

	        firebase.database().ref('/articles').once('value').then(function(snapshot) {
		        articles = snapshot.val();
		    });
	    };

	    signOut = function() {
		    firebase.auth().signOut().then(function() {
		    	window.location.href = "index.html";
			}, function(error) {
			  alert("Sign Out Error");
			  console.error('Sign Out Error', error);
			});
		};

	    var game = new Phaser.Game(800, 800, Phaser.AUTO, 'game', { preload: preload, create: create, update: update });
	    var scoreLoaded = false;

	    function preload() {
		    game.load.image('yesButton','assets/yesButton.jpg');
		    game.load.image('noButton','assets/noButton.jpg');

		    game.load.image('someName','assets/0.png');
		    game.load.image('another','assets/1.jpeg');
		    game.load.image('lol','assets/2.jpg');

		}

		function create() {
			game.stage.backgroundColor = '#ADD8E6';

			var noButton = game.add.button(715, 0, 'noButton', noClicked, this);
			noButton.scale.setTo(.2, .2);

			var yesButton = game.add.button(625, 0, 'yesButton', yesClicked, this);
			yesButton.scale.setTo(.2, .2);
		}

		function update() {
			// TODO: is there a better fix? currently can't set scoreText initially in create because calls to Firebase
			// may not have returned to get the score, so Score: Undefined is printed 
			if (!scoreLoaded && score) {
				scoreLoaded = true;
				scoreText = game.add.text(16, 16, 'Score: ' + score, { fontSize: '32px', fill: '#000' });
			}

			if (switchArticle && articles && articles.length != 0) {
				// Article at index 0 will be this article until user clicks yesButton, or noButton, 
				// after which switchArticle is set to true, score is updated, and article at index 0 is removed
				activeArticle = game.add.sprite(100, 100, articles[0]['name']);
				activeArticle.scale.setTo(.2, .2);
				switchArticle = false;
			}
		}

		function nextArticle() {
			activeArticle.destroy();
			articles.splice(0,1); 
			switchArticle = true;
		}

		function determineScore(userChosen) {
			var correct = articles[0]['answer'];
			if (correct == 'fake' && userChosen == 'fake') {
				alert("CORRECT!");
				return score + 1;
			}
			if (correct == 'real' && userChosen == 'real') {
				alert("CORRECT!");
				return score + 1;
			}
			alert("WRONG!");
			return score - 1;
		}

		function updateScore() {
			var newData = {
				score: score 
			};

			var updates = {};
			updates['/users/' + uid] = newData;

			firebase.database().ref().update(updates);
			scoreText.text = 'Score: ' + score;
		}

		function yesClicked(button) {
			score = determineScore('real');

			updateScore();

			nextArticle();
		}

		function noClicked(button) {
			score = determineScore('fake');

	  		updateScore();

			nextArticle();
		}

		//Sign out button signs user out and redirects to login page
		var signOutButton = document.getElementById('sign-out');
		signOutButton.style.cursor = 'pointer';
		signOutButton.onclick = signOut;

	    window.addEventListener('load', function() {
	        initApp()
	    });

		</script>
	</body>
</html>